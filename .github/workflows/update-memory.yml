name: Update Memory Files

on:
  push:
    paths:
      - 'memory/**'
  schedule:
    - cron: '*/5 * * * *'  # Runs every 5 minutes

jobs:
  update-memory:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: Check for Changes
      id: check_changes
      run: |
        git diff --quiet HEAD~1 HEAD ./memory/ || echo "changes=true" >> $GITHUB_OUTPUT
    
    - name: Update Session History
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
        COMMIT_HASH=$(git rev-parse HEAD)
        CHANGED_FILES=$(git diff --name-status HEAD~1 HEAD ./memory/)
        
        echo "### $TIMESTAMP" >> memory/session-history.md
        echo "- 🔄 **Commit:** $(git log -1 --pretty=%B)" >> memory/session-history.md
        echo "- 👤 **Author:** $(git log -1 --pretty=%an)" >> memory/session-history.md
        echo "- 🔍 **Hash:** \`$COMMIT_HASH\`" >> memory/session-history.md
        echo "- Files changed:" >> memory/session-history.md
        echo "  $CHANGED_FILES" >> memory/session-history.md
        echo "" >> memory/session-history.md
    
    - name: Commit Changes
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        git config --local user.email "actions@github.com"
        git config --local user.name "GitHub Actions"
        git add memory/session-history.md
        git commit -m "[UPDATE] Auto-update session history" || exit 0
        git push